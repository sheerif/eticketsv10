{% extends "base.html" %}
{% load formatting %}
{% block title %}Mes tickets · e‑Tickets JO{% endblock %}
{% block content %}
<h1 class="h3 mb-3">Mes tickets</h1>
{% if tickets %}
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
  {% for t in tickets %}
    <div class="col">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title mb-0">{{ t.offer.name }}</h5>
            <small class="text-muted">Ticket #{{ forloop.counter }}</small>
          </div>
          <p class="text-muted small mb-3">Commande #{{ t.order_id }}</p>
          
          <div class="mb-3">
            <div class="d-flex align-items-center gap-2 mb-2">
              <code class="text-break small">{{ t.ticket_key|shortkey:12 }}</code>
              <button class="btn btn-sm btn-outline-secondary" onclick="copyKey('{{ t.ticket_key }}')">
                Copier
              </button>
            </div>
            {% if t.qr_image %}
            <div class="text-center">
              <img src="{{ t.qr_image.url }}" alt="QR Code" class="img-fluid" style="max-width: 150px;">
              <div class="mt-2">
                <a href="{{ t.qr_image.url }}" class="btn btn-sm btn-outline-primary" download>
                  Télécharger QR
                </a>
              </div>
            </div>
            {% else %}
            <div class="text-muted small">QR non disponible</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
  </div>
{% else %}
  <div class="alert alert-info">
    <h5>Aucun ticket trouvé</h5>
    <p class="mb-0">Vous n'avez pas encore de tickets. <a href="/offers/" class="alert-link">Voir les offres</a></p>
  </div>
{% endif %}

<script>
async function copyKey(key) {
  try {
    await navigator.clipboard.writeText(key);
    // Retour visuel simple
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = '✓ Copié';
    btn.classList.add('btn-success');
    setTimeout(() => {
      btn.textContent = originalText;
      btn.classList.remove('btn-success');
    }, 2000);
  } catch (err) {
    console.error('Erreur de copie:', err);
    alert('Impossible de copier. Clé: ' + key);
  }
}
</script>
{% endblock %}