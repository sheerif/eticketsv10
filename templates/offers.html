{% extends "base.html" %}
{% block title %}Billets disponibles ¬∑ e‚ÄëTickets JO 2024{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
  <div class="mb-3 mb-md-0">
    <h1 class="h3 fw-bold text-primary mb-2">üé´ Billets disponibles</h1>
    <p class="text-muted mb-0">Choisissez vos √©v√©nements pr√©f√©r√©s</p>
  </div>
  {% if offers %}
  <div class="badge bg-success fs-6 px-3 py-2">
    {{ offers|length }} √©v√©nement{{ offers|length|pluralize }} disponible{{ offers|length|pluralize }}
  </div>
  {% endif %}
</div>

<noscript>
  <div class="alert alert-warning mb-4">
    ‚ö†Ô∏è <strong>JavaScript requis</strong> pour utiliser le panier.
  </div>
</noscript>

<div class="row g-4">
  <!-- Liste des offres -->
  <div class="col-lg-8">
    {% if offers %}
      <div class="row row-cols-1 row-cols-sm-2 g-3">
        {% for o in offers %}
        <div class="col">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <!-- En-t√™te de l'√©v√©nement -->
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h3 class="h5 fw-bold mb-0">{{ o.name }}</h3>
                <span class="badge bg-primary-subtle text-primary-emphasis">
                  {% if o.get_offer_type_display == 'Solo' %}üë§{% elif o.get_offer_type_display == 'Duo' %}üë•{% else %}üë®‚Äçüë©‚Äçüëß‚Äçüë¶{% endif %}
                  {{ o.get_offer_type_display }}
                </span>
              </div>

              <!-- D√©tails -->
              <div class="text-muted small mb-3">
                <div class="mb-1">üìÖ 26 juillet - 11 ao√ªt 2024</div>
                <div class="mb-1">üìç Stade de France, Paris</div>
                <div>‚è∞ Sessions disponibles</div>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <p class="text-muted small mb-0">
                  {% if 'Athl√©tisme' in o.name %}
                    Sprint, marathon, saut et lancer avec les meilleurs athl√®tes du monde.
                  {% elif 'Natation' in o.name %}
                    Comp√©titions aquatiques avec les nageurs les plus rapides de la plan√®te.
                  {% elif 'Cyclisme' in o.name %}
                    Courses palpitantes sur piste et sur route dans un cadre exceptionnel.
                  {% else %}
                    Une exp√©rience olympique inoubliable dans ce sport passionnant !
                  {% endif %}
                </p>
              </div>

              <!-- Prix et action -->
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fs-4 fw-bold text-success">{{ o.price_eur }} ‚Ç¨</div>
                  <small class="text-muted">par personne</small>
                </div>
                <button class="btn btn-primary" onclick="addToCart({{ o.id }})">
                  Ajouter
                </button>
              </div>
            </div>
            
            <!-- Footer -->
            <div class="card-footer bg-transparent border-0 pt-0">
              <div class="d-flex justify-content-between text-muted small">
                <span>üéØ Places limit√©es</span>
                <span>‚úÖ Livraison instantan√©e</span>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-5">
        <div class="fs-1 mb-3">üé™</div>
        <h3 class="h4 mb-3">Aucun billet disponible</h3>
        <p class="text-muted mb-4">Les √©v√©nements seront bient√¥t ouverts √† la r√©servation.</p>
        <div class="alert alert-info">
          <strong>D√©veloppeurs :</strong> Ex√©cutez <code>python manage.py seed_offers</code>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Panier -->
  <div class="col-lg-4">
    <div class="card shadow border-0 position-sticky" style="top: 2rem;">
      <!-- En-t√™te du panier -->
      <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0 fw-bold">üõí Mon panier</h2>
          <button class="btn btn-sm btn-outline-light" onclick="resetCart()">
            Vider
          </button>
        </div>
      </div>
      
      <!-- Contenu du panier -->
      <div class="card-body">
        <div id="cart-items" class="mb-3">
          <div class="text-center text-muted py-4">
            <div class="fs-4 mb-2">üõí</div>
            <p class="mb-0">Panier vide</p>
          </div>
        </div>
        
        <hr/>
        
        <!-- Total -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <strong>Total</strong>
          <strong class="fs-4 text-success" id="cart-total">0 ‚Ç¨</strong>
        </div>
        
        <!-- Bouton de paiement -->
        <div class="d-grid">
          <button class="btn btn-success btn-lg fw-bold" onclick="onCheckout()">
            üí≥ Payer maintenant
          </button>
          <small class="text-center text-muted mt-2">
            üîí Paiement s√©curis√©
          </small>
        </div>
      </div>

      <!-- Avantages -->
      <div class="card-footer bg-light">
        <div class="row g-2 text-center small">
          <div class="col-4">
            <div class="text-primary">‚ö°</div>
            <div class="fw-medium">Instantan√©</div>
          </div>
          <div class="col-4">
            <div class="text-success">üì±</div>
            <div class="fw-medium">Mobile</div>
          </div>
          <div class="col-4">
            <div class="text-warning">üõ°Ô∏è</div>
            <div class="fw-medium">S√©curis√©</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* Cart JS: AJAX first, robust GET fallback; no syntax errors. */
(function(){
  function getCookie(name){
    const m = document.cookie.match('(^|;)\s*'+name+'\s*=\s*([^;]+)');
    return m ? m.pop() : '';
  }
  async function fetchCart(){
    const r = await fetch('/api/cart/', {credentials:'same-origin'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }
  async function updateCart(){
    try{
      const data = await fetchCart();
      const items = document.getElementById('cart-items');
      const total = document.getElementById('cart-total');
      
      if(!data.items || data.items.length === 0){
        items.innerHTML = '<div class="text-muted small">Panier vide</div>';
        total.textContent = '0 ‚Ç¨';
        return;
      }
      
      items.innerHTML = data.items.map(item => {
        // DEBUG: log the item structure
        console.log('Cart item:', item);
        
        // Robust price calculation with null/undefined handling
        const itemPrice = (item.price !== null && item.price !== undefined) ? Number(item.price) : 0;
        const itemQty = (item.qty !== null && item.qty !== undefined) ? Number(item.qty) : 0;
        const itemLineTotal = (item.line_total !== null && item.line_total !== undefined) ? Number(item.line_total) : 0;
        
        // prefer API-provided `line_total`, fallback to price*qty
        let line = itemLineTotal;
        if (!line || isNaN(line)) {
          line = itemPrice * itemQty;
        }
        if (!line || isNaN(line)) {
          line = 0;  // Final fallback
        }
        
        const lineStr = line.toFixed(2).replace('.', ',');
        
        console.log(`Price calc: line_total=${item.line_total}, price=${item.price}, qty=${item.qty}, calculated=${line}`);
        
        return `
        <div class="d-flex justify-content-between align-items-center">
          <div class="small">
            <div class="fw-medium">${item.name}</div>
            <div class="text-muted">Qt√©: ${item.qty}</div>
          </div>
          <div class="small text-end">
            <div>${lineStr} ‚Ç¨</div>
            <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.offer_id})">√ó</button>
          </div>
        </div>
      `;
      }).join('');

      // format total to 2 decimals (use comma as decimal separator for FR locales)
      let totalVal = 0;
      if (data.total !== null && data.total !== undefined && !isNaN(data.total)) {
        totalVal = Number(data.total);
      } else {
        // Fallback: calculate from items
        totalVal = data.items.reduce((sum, item) => {
          const itemLineTotal = (item.line_total !== null && item.line_total !== undefined) ? Number(item.line_total) : 0;
          if (itemLineTotal && !isNaN(itemLineTotal)) {
            return sum + itemLineTotal;
          }
          const itemPrice = (item.price !== null && item.price !== undefined) ? Number(item.price) : 0;
          const itemQty = (item.qty !== null && item.qty !== undefined) ? Number(item.qty) : 0;
          if (itemPrice && itemQty && !isNaN(itemPrice) && !isNaN(itemQty)) {
            return sum + (itemPrice * itemQty);
          }
          return sum;
        }, 0);
      }
      total.textContent = `${totalVal.toFixed(2).replace('.', ',')} ‚Ç¨`;
    }catch(e){
      console.error('Erreur cart:', e);
      document.getElementById('cart-items').innerHTML = '<div class="text-danger small">Erreur de chargement</div>';
    }
  }
  
  window.addToCart = async function(offerId){
    try{
      const r = await fetch('/api/cart/add/', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken': getCookie('csrftoken')},
        credentials:'same-origin',
        body: JSON.stringify({offer_id: offerId, qty: 1})
      });
      if(r.ok) updateCart();
      else throw new Error('HTTP '+r.status);
    }catch(e){
      console.log('Fallback to GET for offer', offerId);
      window.location.href = `/orders/cart/add/${offerId}/?qty=1&next=/offers/`;
    }
  };
  
  window.removeFromCart = async function(offerId){
    try{
      const r = await fetch('/api/cart/update/', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken': getCookie('csrftoken')},
        credentials:'same-origin',
        body: JSON.stringify({offer_id: offerId, qty: 0})
      });
      if(r.ok) updateCart();
      else throw new Error('HTTP '+r.status);
    }catch(e){
      console.log('Fallback to GET remove');
      window.location.href = `/orders/cart/update/${offerId}/?qty=0&next=/offers/`;
    }
  };
  
  window.resetCart = async function(){
    try{
      const r = await fetch('/api/cart/clear/', {
        method:'POST',
        headers:{'X-CSRFToken': getCookie('csrftoken')},
        credentials:'same-origin'
      });
      if(r.ok) updateCart();
      else throw new Error('HTTP '+r.status);
    }catch(e){
      console.log('Fallback to GET clear');
      window.location.href = '/orders/cart/clear/?next=/offers/';
    }
  };
  
  window.onCheckout = async function(){
    try{
      const r = await fetch('/api/cart/checkout/', {
        method:'POST',
        headers:{'X-CSRFToken': getCookie('csrftoken')},
        credentials:'same-origin'
      });
      if(r.ok){
        const data = await r.json();
        if(data.ok) window.location.href = '/my/tickets/';
        else alert('Erreur: ' + (data.error || 'Inconnu'));
      } else if(r.status === 403) {
        window.location.href = '/login/?next=/offers/';
      } else {
        throw new Error('HTTP '+r.status);
      }
    }catch(e){
      console.log('Fallback to GET checkout');
      window.location.href = '/orders/checkout/';
    }
  };
  
  updateCart();
  setInterval(updateCart, 10000); // Refresh every 10s
})();
</script>
{% endblock %}